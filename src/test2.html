<!DOCTYPE html>
<html>
<head>
  <title>Screen Capture Every 60s</title>
</head>
<body>
  <button id="startCapture">Start Screen Capture</button>

  <script>
    const CAPTURE_INTERVAL = 60000; // 60 seconds
    let videoEl = null;
    let captureStream = null;

    async function startCapture() {
      try {
        // Ask user to choose a screen or window to share
        captureStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });

        // Create and start hidden video element
        videoEl = document.createElement('video');
        videoEl.style.display = 'none';
        document.body.appendChild(videoEl);
        videoEl.srcObject = captureStream;

        // Wait until the video has enough data to draw
        await new Promise(resolve => {
          videoEl.onloadedmetadata = () => {
            videoEl.play();
            resolve();
          };
        });

        console.log("Screen capture started");
        takeScreenshot(); // take first immediately
        setInterval(takeScreenshot, CAPTURE_INTERVAL);
      } catch (err) {
        console.error("Error starting capture:", err);
      }
    }

    async function takeScreenshot() {
      if (!videoEl || videoEl.videoWidth === 0) {
        console.warn("Video not ready yet, skipping screenshot");
        return;
      }

      const canvas = document.createElement('canvas');
      canvas.width = videoEl.videoWidth;
      canvas.height = videoEl.videoHeight;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);

      try {
        // Create a PNG blob (fallback to base64 if needed)
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        if (!blob) throw new Error("Failed to create blob from canvas");

        const formData = new FormData();
        formData.append('screenshot', blob, 'screenshot.png');

        await fetch('/upload', {
          method: 'POST',
          body: formData
        });
        console.log("Screenshot sent at", new Date().toLocaleTimeString());
      } catch (err) {
        console.error("Upload failed:", err);
      }
    }

    document.getElementById('startCapture').addEventListener('click', startCapture);
  </script>
</body>
</html>
